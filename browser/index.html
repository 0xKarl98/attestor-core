<html>
<head>
    <script>
		function isObjectProperty(property) {
			return (typeof property) === 'object' && !Array.isArray(property) && property !== null
		}

		function getReplacer() {
			// Store references to previously visited objects
			const references = new WeakSet()

			return function (key, value) {
				const isObject = (typeof value) === 'object' && value !== null
				if (isObject) {
					if (references.has(value)) {
						return '[CIRCULAR]'
					}

					references.add(value)
				}

				return value
			}
		}


		const properties = ['ownerPrivateKey', 'secretParams']
		const redactedText = '[REDACTED]'

		function redact(json) {
			const isObject = isObjectProperty(json)

			if (!isObject && !Array.isArray(json)) {
				return json
			}

			const redacted = JSON.parse(JSON.stringify(json, getReplacer()))

			for (const prop in redacted) {
				if (properties.includes(prop)) {
					redacted[prop] = redactedText
				}

				if (Array.isArray(redacted[prop])) {
					redacted[prop].forEach((value, index) => {
						redacted[prop][index] = redact(value)
					})
				} else if (isObjectProperty(redacted[prop])) {
					redacted[prop] = redact(redacted[prop])
				}
			}

			return redacted
		}

		function consoleLog (level, log) {
			window.ReactNativeWebView.postMessage(
				JSON.stringify({'type': 'console', level, 'data': redact(log)})
			)
		}

		console = {
			log: (...log) => consoleLog('log', log),
			debug: (...log) => consoleLog('debug', log),
			info: (...log) => consoleLog('info', log),
			warn: (...log) => consoleLog('warn', log),
			error: (...log) => consoleLog('error', log),
		};

    </script>


    <script>
		module = {};
    </script>
    <script src="/resources/reclaim-witness.min.js">
    </script>
    <script>
		module.exports.setupWindowRpc()
    </script>

    <script>
		function appendMemoryUsageStr(str) {
			document.getElementById('memory-usage').innerHTML += `[${new Date().toJSON()}] Memory usage: ${str}<br/>`;
		}

		function trackMemoryUsage() {
			let prevmemusage = ''
			const interval = setInterval(setMemoryUsage, 25)
			setMemoryUsage()

			async function setMemoryUsage() {
				const result = await module.exports.getCurrentMemoryUsage();
				if (prevmemusage === result.content) {
					return
				}

				appendMemoryUsageStr(result.content)
				if (!result.available) {
					clearInterval(interval)
					console.warn('Memory usage tracking is not available: ', result.content)
				} else {
					console.log('Memory usage: ', result.content)
				}

				prevmemusage = result.content
			}
		}

		if (window.location.search.includes('track-memory-usage=true')) {
			trackMemoryUsage()
		}
    </script>
</head>
<body>
<h6>
    Witness SDK RPC
</h6>

<span id='memory-usage'>
		
	</span>
</body>
</html>